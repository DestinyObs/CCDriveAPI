-- MSSQL Table Schemas for TheDrive
CREATE TABLE Plans (
    Id INT IDENTITY PRIMARY KEY,
    Name NVARCHAR(100) NOT NULL,
    Price DECIMAL(18,2) NOT NULL,
    StorageLimit BIGINT NOT NULL,
    Features NVARCHAR(MAX) NOT NULL
);

CREATE TABLE Users (
    Id NVARCHAR(450) PRIMARY KEY,
    Name NVARCHAR(100) NOT NULL,
    Email NVARCHAR(256) NOT NULL,
    PasswordHash NVARCHAR(MAX) NOT NULL,
    PlanId INT NULL,
    CreatedAt DATETIME2 NOT NULL,
    CONSTRAINT FK_Users_Plans FOREIGN KEY (PlanId) REFERENCES Plans(Id)
);

CREATE TABLE Folders (
    Id INT IDENTITY PRIMARY KEY,
    UserId NVARCHAR(450) NOT NULL,
    ParentId INT NULL,
    Name NVARCHAR(100) NOT NULL,
    CreatedAt DATETIME2 NOT NULL,
    CONSTRAINT FK_Folders_Users FOREIGN KEY (UserId) REFERENCES Users(Id),
    CONSTRAINT FK_Folders_Parent FOREIGN KEY (ParentId) REFERENCES Folders(Id)
);

CREATE TABLE Files (
    Id INT IDENTITY PRIMARY KEY,
    UserId NVARCHAR(450) NOT NULL,
    FolderId INT NULL,
    Name NVARCHAR(255) NOT NULL,
    S3Key NVARCHAR(255) NOT NULL,
    Size BIGINT NOT NULL,
    IsTrashed BIT NOT NULL,
    Version INT NOT NULL,
    CreatedAt DATETIME2 NOT NULL,
    UpdatedAt DATETIME2 NOT NULL,
    Permissions NVARCHAR(50) NOT NULL,
    CONSTRAINT FK_Files_Users FOREIGN KEY (UserId) REFERENCES Users(Id),
    CONSTRAINT FK_Files_Folders FOREIGN KEY (FolderId) REFERENCES Folders(Id)
);

CREATE TABLE FileVersions (
    Id INT IDENTITY PRIMARY KEY,
    FileId INT NOT NULL,
    S3Key NVARCHAR(255) NOT NULL,
    CephKey NVARCHAR(255) NULL,
    Version INT NOT NULL,
    CreatedAt DATETIME2 NOT NULL,
    CONSTRAINT FK_FileVersions_Files FOREIGN KEY (FileId) REFERENCES Files(Id)
);

CREATE TABLE SharedFiles (
    Id INT IDENTITY PRIMARY KEY,
    FileId INT NOT NULL,
    SharedWithUserId NVARCHAR(450) NOT NULL,
    Permission NVARCHAR(50) NOT NULL,
    CreatedAt DATETIME2 NOT NULL,
    CONSTRAINT FK_SharedFiles_Files FOREIGN KEY (FileId) REFERENCES Files(Id),
    CONSTRAINT FK_SharedFiles_Users FOREIGN KEY (SharedWithUserId) REFERENCES Users(Id)
);

CREATE TABLE Activities (
    Id INT IDENTITY PRIMARY KEY,
    UserId NVARCHAR(450) NOT NULL,
    Action NVARCHAR(50) NOT NULL,
    FileId INT NULL,
    Details NVARCHAR(MAX) NULL,
    CreatedAt DATETIME2 NOT NULL,
    CONSTRAINT FK_Activities_Users FOREIGN KEY (UserId) REFERENCES Users(Id),
    CONSTRAINT FK_Activities_Files FOREIGN KEY (FileId) REFERENCES Files(Id)
);

CREATE TABLE Subscriptions (
    Id INT IDENTITY PRIMARY KEY,
    UserId NVARCHAR(450) NOT NULL,
    PlanId INT NOT NULL,
    Status NVARCHAR(50) NOT NULL,
    StartedAt DATETIME2 NOT NULL,
    EndedAt DATETIME2 NULL,
    PaymentProvider NVARCHAR(100) NULL,
    PaymentId NVARCHAR(100) NULL,
    CONSTRAINT FK_Subscriptions_Users FOREIGN KEY (UserId) REFERENCES Users(Id),
    CONSTRAINT FK_Subscriptions_Plans FOREIGN KEY (PlanId) REFERENCES Plans(Id)
);

CREATE TABLE OTPs (
    Id INT IDENTITY PRIMARY KEY,
    UserId NVARCHAR(450) NOT NULL,
    OTP NVARCHAR(10) NOT NULL,
    ExpiresAt DATETIME2 NOT NULL,
    Used BIT NOT NULL,
    CONSTRAINT FK_OTPs_Users FOREIGN KEY (UserId) REFERENCES Users(Id)
);

CREATE TABLE SupportTickets (
    Id INT IDENTITY PRIMARY KEY,
    UserId NVARCHAR(450) NOT NULL,
    Subject NVARCHAR(255) NOT NULL,
    Message NVARCHAR(MAX) NOT NULL,
    Priority NVARCHAR(50) NOT NULL,
    Status NVARCHAR(50) NOT NULL,
    CreatedAt DATETIME2 NOT NULL,
    CONSTRAINT FK_SupportTickets_Users FOREIGN KEY (UserId) REFERENCES Users(Id)
);
